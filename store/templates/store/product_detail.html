{% extends 'store/base.html' %}
{% load static %}


{% block content %}
<div class="container my-5">


    {% csrf_token %}


    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}

    <div class="row">

        <div class="col-md-6">
            <div class="row">

                <div class="col-2">
                    <div class="thumbnail-gallery">

                        <img src="{{ product.image_url }}" class="img-fluid thumbnail-item active"
                            onclick="changeImage(this)">

                        {% for img in product.images.all %}

                        <img src="{{ img.image_url }}" class="img-fluid thumbnail-item" onclick="changeImage(this)">
                        {% endfor %}
                    </div>
                </div>

                <div class="col-10">
                    <div class="zoom-container">

                        <img src="{{ product.image_url }}" id="main-product-image" class="img-fluid rounded"
                            alt="{{ product.name }}">
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="d-flex align-items-center mb-2">
                <h1>{{ product.name }}</h1>
                {% if average_rating %}
                <span class="badge bg-warning text-dark ms-3">
                    ‚≠ê {{ average_rating }}
                </span>
                {% endif %}
            </div>
            <p class="lead text-muted">{{ product.description }}</p>
            <hr>
            <h3 class="mb-3">
                Price: ‚Çπ{{ product.price }}
                {% if product.market_price and product.market_price > product.price %}
                <small class="text-muted ms-2"><del>‚Çπ{{ product.market_price }}</del></small>
                {% if discount_percent %}
                <span class="badge bg-success ms-2">{{ discount_percent|floatformat:2 }}% OFF</span>
                {% endif %}
                {% endif %}
            </h3>
            {% if sales_last_7_days > 0 %}
            <div class="alert alert-info mt-3" style="font-weight: bold; text-align: center;">
                üî•Sold <strong>{{ sales_last_7_days }}</strong> times in the last 7 days!
            </div>
            {% endif %}


            {% if product.highlights %}
            <div class="highlights-section my-4">
                <h6 class="fw-bold">Highlights</h6>
                <ul class="list-unstyled ps-0">
                    {% for line in product.highlights.splitlines %}
                    <li class="d-flex"><span class="me-2">‚Ä¢</span>{{ line }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}


            <div class="mt-4">
                <h5>Check Estimated Delivery Date</h5>
                <div class="input-group mb-3" style="max-width: 300px;">
                    <input type="text" class="form-control" id="pincode-input" placeholder="Enter Pincode">
                    <button class="btn btn-outline-secondary" type="button" id="check-pincode-btn">Check</button>
                </div>
                <div id="delivery-result"></div>
            </div>


            {% if product.stock > 0 %}
            <form action="{% url 'add_to_cart' product_id=product.id %}" method="post"
                class="d-flex align-items-center mb-3">
                {% csrf_token %}
                <div class="input-group me-3" style="width: 150px;">
                    <button class="btn btn-outline-secondary" type="button" id="decrement-btn">-</button>
                    <input type="number" name="quantity" id="product-quantity" class="form-control text-center"
                        value="1" min="1" max="{{ product.stock }}">
                    <button class="btn btn-outline-secondary" type="button" id="increment-btn">+</button>
                </div>
                <button type="submit" class="btn btn-primary btn-lg">Add to Cart üõí</button>
            </form>


            {% if user.is_authenticated %}
            <a href="{% url 'toggle_wishlist' product_id=product.id %}"
                class="btn {% if is_wishlisted %}btn-danger{% else %}btn-outline-danger{% endif %} btn-lg">
                {% if is_wishlisted %} ‚ù§Ô∏è In Wishlist {% else %} ü§ç Add to Wishlist {% endif %}
            </a>
            <a href="{% url 'toggle_price_notification' product_id=product.id %}"
                class="btn {% if is_price_subscribed %}btn-secondary{% else %}btn-outline-secondary{% endif %} btn-lg mt-2">
                {% if is_price_subscribed %} ‚úîÔ∏è Subscribed to Price Drop {% else %} üîî Notify Me of Price Drop
                {% endif %}
            </a>
            {% endif %}


            {% else %}
            <p class="text-danger fw-bold h5">Currently Out of Stock</p>
            {% if user.is_authenticated %}
            {% if is_subscribed %}
            <a href="{% url 'toggle_stock_notification' product_id=product.id %}" class="btn btn-success btn-lg mt-2">‚úîÔ∏è
                Subscribed (Click to Unsubscribe)</a>
            {% else %}
            <a href="{% url 'toggle_stock_notification' product_id=product.id %}"
                class="btn btn-info btn-lg mt-2">Notify Me When Available</a>
            {% endif %}
            {% else %}
            <p class="mt-3"><a href="{% url 'login' %}?next={{ request.path }}">Login</a> to be notified when this item
                is back in stock.</p>
            {% endif %}
            {% endif %}
        </div>

    </div>

    <div class="row mt-5">
        <div class="col-md-12">
            <h3 class="mb-4">Customer Reviews</h3>
            <hr>


            {% if user.is_authenticated %}
            {% if not user_has_reviewed %}
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <h5>Write a Review</h5>
                    <form method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="{{ form.rating.id_for_label }}" class="form-label">Rating</label>
                            {{ form.rating }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.comment.id_for_label }}" class="form-label">Comment</label>
                            {{ form.comment }}
                        </div>
                        <button type="submit" class="btn btn-success">Submit Review</button>
                    </form>
                </div>
            </div>
            {% else %}
            <div class="alert alert-info">You have already submitted a review for this product.</div>
            {% endif %}
            {% else %}
            <div class="alert alert-warning"><a href="{% url 'login' %}?next={{ request.path }}">Login</a> to write a
                review.</div>
            {% endif %}


            {% if reviews %}
            {% for review in reviews %}
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">{{ review.user.username }}
                        <span class="badge bg-secondary">{{ review.get_rating_display }}</span>
                    </h5>
                    <p class="card-text">{{ review.comment }}</p>
                    <small class="text-muted">Reviewed on: {{ review.created_at|date:"d M Y" }}</small>
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="alert alert-info">No reviews yet. Be the first to write one!</div>
            {% endif %}
        </div>
    </div>

</div>


<script>
    function changeImage(element) {
        var mainImage = document.getElementById('main-product-image');
        mainImage.src = element.src;
        var thumbnails = document.getElementsByClassName('thumbnail-item');
        for (var i = 0; i < thumbnails.length; i++) {
            thumbnails[i].classList.remove('active');
        }
        element.classList.add('active');
    }

    document.getElementById('decrement-btn').addEventListener('click', function () {
        let quantityInput = document.getElementById('product-quantity');
        let currentValue = parseInt(quantityInput.value);
        if (currentValue > 1) {
            quantityInput.value = currentValue - 1;
        }
    });
    document.getElementById('increment-btn').addEventListener('click', function () {
        let quantityInput = document.getElementById('product-quantity');
        let currentValue = parseInt(quantityInput.value);
        let maxStock = parseInt(quantityInput.max);
        if (currentValue < maxStock) {
            quantityInput.value = currentValue + 1;
        }
    });

    document.getElementById('check-pincode-btn').addEventListener('click', function () {
        const pincode = document.getElementById('pincode-input').value;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const deliveryResultDiv = document.getElementById('delivery-result');


        fetch("{% url 'check_delivery' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': csrfToken
                },
                body: `pincode=${pincode}`
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'Server error');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.estimated_date) {
                    deliveryResultDiv.innerHTML =
                        `<p class="text-success">Estimated delivery to ${data.city} by: <b>${data.estimated_date}</b></p>`;
                } else if (data.error) {
                    deliveryResultDiv.innerHTML =
                        `<p class="text-danger">${data.error}</p>`;
                } else {
                    deliveryResultDiv.innerHTML =
                        `<p class="text-danger">An unknown error occurred. Please try again.</p>`;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                deliveryResultDiv.innerHTML =
                    `<p class="text-danger">${error.message}</p>`;
            });
    });
</script>

<style>
    .ai-chat-fab {
        position: fixed;
        bottom: 25px;
        right: 25px;
        background-color: #007bff;
        color: white;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 28px;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 999;
        transition: transform 0.2s;
    }

    .ai-chat-fab:hover {
        transform: scale(1.1);
    }

    .ai-chat-window {
        position: fixed;
        bottom: 100px;
        right: 25px;
        width: 350px;
        max-width: 90%;
        height: 500px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        display: none;
        flex-direction: column;
        z-index: 1000;
        overflow: hidden;
        border: 1px solid #ccc;
    }

    .ai-chat-window.open {
        display: flex;
    }

    .ai-chat-header {
        background: #007bff;
        color: white;
        padding: 15px;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .ai-chat-close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
    }

    .ai-chat-messages {
        flex-grow: 1;
        padding: 15px;
        overflow-y: auto;
        background-color: #f4f7f9;
        display: flex;
        flex-direction: column;
    }

    .ai-chat-messages p {
        background-color: #e9e9eb;
        padding: 10px 15px;
        border-radius: 18px;
        margin-bottom: 10px;
        max-width: 80%;
        align-self: flex-start;
    }

    .ai-chat-input-area {
        display: flex;
        padding: 10px;
        border-top: 1px solid #ddd;
        background-color: #fff;
    }

    .ai-chat-input-area input {
        flex-grow: 1;
        border: 1px solid #ccc;
        border-radius: 20px;
        padding: 10px 15px;
        margin-right: 10px;
    }

    .ai-chat-input-area button {
        background-color: #007bff;
        border: none;
        color: white;
        border-radius: 50%;
        width: 45px;
        height: 45px;
        font-size: 18px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .ai-chat-input-area button:hover {
        background-color: #0056b3;
    }
</style>

<div class="ai-chat-fab" id="ai-chat-toggle-btn">
    ü§ñ
</div>

<div class="ai-chat-window" id="ai-chat-window" data-product-id="{{ product.id }}">
    <div class="ai-chat-header">
        <span>AI Product Helper</span>
        <button class="ai-chat-close-btn" id="ai-chat-close-btn">&times;</button>
    </div>
    <div class="ai-chat-messages" id="ai-chat-messages">
        <p>Hi! How can I help you with this product?</p>
    </div>
    <div class="ai-chat-input-area">
        <input type="text" id="ai-chat-input" placeholder="Ask a question...">
        <button id="ai-chat-send-btn">‚û§</button>
    </div>
</div>
<script>
    const chatWindow = document.getElementById('ai-chat-window');
    const toggleBtn = document.getElementById('ai-chat-toggle-btn');
    const closeBtn = document.getElementById('ai-chat-close-btn');
    const messagesArea = document.getElementById('ai-chat-messages');
    const sendBtn = document.getElementById('ai-chat-send-btn');
    const inputBox = document.getElementById('ai-chat-input');


    toggleBtn.addEventListener('click', () => chatWindow.classList.toggle('open'));
    closeBtn.addEventListener('click', () => chatWindow.classList.remove('open'));
    sendBtn.addEventListener('click', sendMessage);
    inputBox.addEventListener('keyup', function (event) {
        if (event.key === "Enter") {
            sendMessage();
        }
    });

    function sendMessage() {
        const question = inputBox.value.trim();
        if (question === "") {
            return;
        }
        addMessage(question, 'user');
        inputBox.value = "";


        addMessage('...', 'bot', true);
        const productId = chatWindow.dataset.productId;
        const url = "{% url 'ask_ai' %}";
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    product_id: productId,
                    question: question
                })
            })
            .then(response => response.json())
            .then(data => {
                updateLastBotMessage(data.answer);
            })
            .catch(error => {
                console.error('Error:', error);
                updateLastBotMessage('Sorry, something went wrong. Please try again.');
            });
    }

    function addMessage(text, type, isLoading = false) {
        const p = document.createElement('p');
        p.textContent = text;
        p.className = `message ${type}-message`;
        if (isLoading) {
            p.id = 'loading-message';
        }
        messagesArea.appendChild(p);
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    function updateLastBotMessage(text) {
        const loadingMessage = document.getElementById('loading-message');
        if (loadingMessage) {
            loadingMessage.textContent = text;
            loadingMessage.id = '';
        }
    }

    const styleSheet = document.createElement("style");
    styleSheet.innerText = `
        .user-message { 
            align-self: flex-end; 
            background-color: #007bff; 
            color: white; 
        }
        .bot-message {
            align-self: flex-start;
            background-color: #e9e9eb;
        }
    `;
    document.head.appendChild(styleSheet);
</script>

{% endblock %}